<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CIEPD Admin Dashboard – Manage News</title>
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{
    --primary: #0077b6;
    --secondary: #00b4d8;
    --accent: #023047;
    --muted: #6b7280;
    --danger: #e63946;
    --success: #06d6a0;
    --card: #ffffff;
    --glass: rgba(255,255,255,0.85);
    --radius: 14px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Inter", "Segoe UI", Poppins, system-ui, -apple-system, sans-serif;
    background: linear-gradient(180deg,#e6f7ff 0%, #f8feff 100%);
    color: #0b2447;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
  }

  .scroll-container {
    width: 300px;
    overflow: hidden;
    white-space: nowrap;
  }
  .scroll-text {
    display: inline-block;
    padding-left: 100%;
    animation: scroll-left 20s linear infinite;
    font-weight: 700;
    color: var(--primary);
  }
  @keyframes scroll-left {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 28px;
    background: linear-gradient(90deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45));
    border-bottom: 1px solid rgba(11,36,71,0.06);
    backdrop-filter: blur(6px);
  }

  .brand { font-weight:700; color:var(--primary); font-size:20px; }

  .logout-btn{
    background:var(--danger);
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:999px;
    cursor:pointer;
    font-weight:600;
  }

  .nav-bar{
    display:flex;
    gap:10px;
    justify-content:center;
    padding:12px;
    background: linear-gradient(90deg, rgba(0,119,182,0.06), rgba(0,180,216,0.03));
  }
  .nav-bar a{
    text-decoration:none;
    padding:9px 16px;
    border-radius:999px;
    color:var(--accent);
    border:1px solid rgba(3,37,61,0.05);
    font-weight:600;
  }
  .nav-bar a.special-btn{
    background:var(--primary);
    color:white;
    border:none;
  }

  .container{
    width:94%;
    max-width:1200px;
    margin:28px auto;
    background:var(--card);
    border-radius:var(--radius);
    padding:26px;
    box-shadow: 0 10px 30px rgba(3,37,61,0.06);
  }

  h1{ margin:0 0 18px 0; color:var(--primary); font-size:20px; }

  .top-row{
    display:flex;
    gap:16px;
    justify-content:space-between;
    align-items:center;
  }

  .filters{ display:flex; gap:12px; flex-wrap:wrap; }
  .filters input, .filters select{
    padding:10px 14px;
    border-radius:999px;
    border:1px solid #e6eef6;
    min-width:230px;
    background:#fbfdff;
  }

  .news-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
    gap:16px;
    margin-top:12px;
  }
  .news-card{
    background:linear-gradient(180deg,#ffffff,#fbfdff);
    padding:16px;
    border-radius:12px;
    border-left:4px solid var(--primary);
    box-shadow: 0 6px 18px rgba(3,37,61,0.04);
    cursor:pointer;
    transition:0.15s;
  }
  .news-card:hover{ transform: translateY(-6px); }

  .news-title{ font-weight:700; color:var(--accent); margin:0; font-size:16px; }
  .news-desc{ color:var(--muted); margin:6px 0; font-size:14px; }

  .badge{
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    color:white;
  }
  .verified{ background:var(--success); }
  .unverified{ background:var(--danger); }
  .approved{ background:var(--primary); }

  #pagination{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:22px;
  }
  #pagination button{
    background:var(--primary);
    border:none;
    color:white;
    padding:8px 16px;
    border-radius:999px;
    cursor:pointer;
    font-weight:700;
  }

  .side-panel{
    position:fixed;
    right:0;
    top:0;
    width:0;
    height:100vh;
    background:white;
    box-shadow:-20px 0 40px rgba(3,37,61,0.1);
    overflow:auto;
    transition:0.25s;
    z-index:9999;
  }
  .side-panel.open{ width:min(900px,100%); }

  .panel-inner{ padding:26px; }

  .panel-title{ margin:0; font-size:22px; font-weight:800; color:var(--primary); }
  .close-btn{
    background:transparent;
    border:none;
    font-size:16px;
    cursor:pointer;
    color:var(--muted);
  }

  .btn{ padding:10px 16px; border:none; border-radius:999px; cursor:pointer; font-weight:700; }
  .btn-verify{ background:var(--success); color:white; }
  .btn-approve{ background:var(--primary); color:white; }
  .btn-delete{ background:var(--danger); color:white; }
</style>
</head>
<body>

<div class="header">
  <div class="brand">
    <div class="scroll-container">
      <div class="scroll-text">Welcome to Conflict Watch Center</div>
    </div>
  </div>
  <button onclick="window.location.href='login.html'" class="logout-btn">Logout</button>
</div>

<div class="nav-bar">
  <a href="home.html">Home</a>
  <a href="report.html">Reports</a>
  <a href="submit.html">Submit</a>
  <a href="getalert.html">Get Alerts</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin-map.html" class="special-btn">Big Map</a>
</div>

<div class="container">

  <div class="top-row">
    <h1 id="modeTitle">Manage News</h1>

    <div style="display:flex; gap:10px;">
      <button id="showNewsBtn" class="btn" style="background:var(--primary);color:white;">View News</button>
      <button id="showReportsBtn" class="btn" style="background:#ddd;color:#000;">View Reports</button>
    </div>

    <div id="status" class="loading" style="display:none">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>Loading
    </div>
  </div>

  <div class="filters">
    <input id="search" type="text" placeholder="Search…" />
    <select id="categoryFilter"><option>All Categories</option></select>

    <button id="refreshBtn" class="btn" style="background:#eef6ff;color:var(--primary);">Refresh</button>
  </div>

  <div id="newsGrid" class="news-grid"></div>
  <div id="pagination"></div>
</div>

<aside id="sidePanel" class="side-panel">
  <div class="panel-inner">

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 id="panelTitle" class="panel-title">Item Title</h2>
      <button id="panelBack" class="close-btn">Close ✖</button>
    </div>

    <div class="panel-meta">
      <p id="panelDate"></p>
      <p id="panelLocation"></p>
      <p id="panelCats"></p>
    </div>

    <div class="panel-block">
      <div id="panelShort" class="panel-text" style="font-weight:700;"></div>
      <div id="panelContent" class="panel-text"></div>
    </div>

    <div class="panel-actions">
      <span id="panelVerifiedBadge" class="badge" style="display:none"></span>
      <span id="panelApprovedBadge" class="badge" style="display:none"></span>
    </div>

    <div id="panelButtons" class="panel-actions"></div>

  </div>
</aside>

<script>
let currentPage = 1;
const pageSize = 40;

/* ⭐ NEW MODE SWITCH */
let currentMode = "news"; // "news" or "reports"

function el(id){ return document.getElementById(id); }
/***********************
  MODE SWITCHING
************************/
el("showNewsBtn").onclick = () => {
  currentMode = "news";
  el("modeTitle").innerText = "Manage News";
  el("showNewsBtn").style.background = "var(--primary)";
  el("showNewsBtn").style.color = "white";
  el("showReportsBtn").style.background = "#ddd";
  el("showReportsBtn").style.color = "#000";
  loadItems();
};

el("showReportsBtn").onclick = () => {
  currentMode = "reports";
  el("modeTitle").innerText = "Manage Reports";
  el("showReportsBtn").style.background = "var(--primary)";
  el("showReportsBtn").style.color = "white";
  el("showNewsBtn").style.background = "#ddd";
  el("showNewsBtn").style.color = "#000";
  loadItems();
};

/***********************
  LOAD CATEGORIES (NEWS ONLY)
************************/
async function loadCategories(){
  try{
    const res = await fetch("/api/news/categories");
    const data = await res.json();
    el("categoryFilter").innerHTML = `<option value="">All Categories</option>`;
    data.forEach(c => {
      el("categoryFilter").innerHTML += `<option value="${c}">${c}</option>`;
    });
  }catch(e){ console.log(e); }
}

/***********************
  OPEN SIDE PANEL
************************/
function openPanel(n){
  el("panelTitle").innerText = n.title || n.incidentType || "Item";

  el("panelShort").innerText = n.description || n.summary || "No short description";
  el("panelContent").innerText = n.content || n.details || "";

  el("panelDate").innerText = new Date(n.createdAt).toLocaleString();
  el("panelLocation").innerText = n.location || n.state || "No location";

  el("panelCats").innerText =
    (n.categories || n.tags || []).join(", ");

  /* VERIFIED badge */
  const v = el("panelVerifiedBadge");
  if(n.verified){
    v.style.display="inline-block";
    v.className="badge verified";
    v.innerText="VERIFIED";
  } else {
    v.style.display="inline-block";
    v.className="badge unverified";
    v.innerText="NOT VERIFIED";
  }

  /* APPROVED badge */
  const a = el("panelApprovedBadge");
  if(n.approved){
    a.style.display="inline-block";
    a.className="badge approved";
    a.innerText="APPROVED";
  } else {
    a.style.display="none";
  }

  /* Buttons */
  el("panelButtons").innerHTML = `
    <button class="btn btn-verify" style="display:${n.verified?'none':''}"
      onclick="verifyItem('${n._id}')">Verify</button>

    <button class="btn btn-approve" style="display:${n.approved?'none':''}"
      onclick="approveItem('${n._id}')">Approve</button>

    <button class="btn btn-delete"
      onclick="deleteItem('${n._id}')">Delete</button>
  `;

  el("sidePanel").classList.add("open");
}

el("panelBack").onclick = () =>
  el("sidePanel").classList.remove("open");

/***********************
 VERIFY (works for news + reports)
************************/
async function verifyItem(id){
  const endpoint = currentMode === "news"
    ? `/api/news/verify/${id}`
    : `/api/reports/verify/${id}`;

  const res = await fetch(endpoint, { method:"PUT" });
  const data = await res.json();

  if(!data.success) return alert("Verification failed");

  el("panelVerifiedBadge").className="badge verified";
  el("panelVerifiedBadge").innerText="VERIFIED";

  const card = document.querySelector(`[data-id="${id}"] .badge-row`);
  if(card){
    card.innerHTML = `<span class="badge verified">VERIFIED</span>`;
  }

  document.querySelector(".btn-verify").style.display="none";
}

/***********************
 APPROVE (works for news + reports)
************************/
async function approveItem(id){
  const endpoint = currentMode === "news"
    ? `/api/news/approve/${id}`
    : `/api/reports/approve/${id}`;

  const res = await fetch(endpoint, { method:"PUT" });
  const data = await res.json();

  if(!data.success) return alert("Approve failed");

  el("panelApprovedBadge").style.display="inline-block";
  el("panelApprovedBadge").className="badge approved";
  el("panelApprovedBadge").innerText="APPROVED";

  document.querySelector(".btn-approve").style.display="none";
}

/***********************
 DELETE (works for news + reports)
************************/
async function deleteItem(id){
  if(!confirm("Delete this item?")) return;

  const endpoint = currentMode === "news"
    ? `/api/news/${id}`
    : `/api/reports/${id}`;

  await fetch(endpoint, { method:"DELETE" });

  document.querySelector(`[data-id="${id}"]`)?.remove();
  el("sidePanel").classList.remove("open");
}

/***********************
  LOAD ITEMS (NEWS + REPORTS)
************************/
async function loadItems(){
  el("status").style.display="inline-flex";

  const search = el("search").value.toLowerCase();
  const category = el("categoryFilter").value;

  let url = "";

  if(currentMode === "news"){
    url = `/api/news?page=${currentPage}&limit=${pageSize}&search=${search}&category=${category}`;
  } else {
    url = `/api/reports?page=${currentPage}&limit=${pageSize}&search=${search}`;
  }

  const res = await fetch(url);
  const data = await res.json();

  renderItems(data.items);
  renderPagination(data.totalPages);

  el("status").style.display="none";
}

/***********************
  RENDER CARDS (NEWS + REPORTS)
************************/
function renderItems(items){
  const grid = el("newsGrid");
  grid.innerHTML = "";

  if(!items || items.length === 0){
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#777;">No items found</div>`;
    return;
  }

  items.forEach(n => {
    const card = document.createElement("div");
    card.className = "news-card";
    card.setAttribute("data-id", n._id);

    const verified = n.verified
      ? `<span class="badge verified">VERIFIED</span>`
      : `<span class="badge unverified">NOT VERIFIED</span>`;

    const approved = n.approved
      ? `<span class="badge approved">APPROVED</span>`
      : "";

    const title = n.title || n.incidentType || "Untitled";
    const desc  = n.description || n.summary || n.details || "";

    card.innerHTML = `
      <div class="badge-row">${verified}${approved}</div>
      <h3 class="news-title">${title}</h3>
      <p class="news-desc">${desc.slice(0,160)}...</p>
    `;

    card.onclick = () => openPanel(n);
    grid.appendChild(card);
  });
}

/***********************
 PAGINATION
************************/
function renderPagination(total){
  const p = el("pagination");
  p.innerHTML = "";

  if(!total || total < 1) return;

  const prev = document.createElement("button");
  prev.textContent = "⬅ Back";
  prev.disabled = currentPage === 1;
  prev.onclick = () => { currentPage--; loadItems(); };

  const next = document.createElement("button");
  next.textContent = "Next ➡";
  next.disabled = currentPage === total;
  next.onclick = () => { currentPage++; loadItems(); };

  const info = document.createElement("span");
  info.className = "page-info";
  info.textContent = `Page ${currentPage} of ${total}`;

  p.append(prev, info, next);
}

/***********************
 EVENTS
************************/
el("search").addEventListener("input", () => {
  currentPage = 1;
  loadItems();
});

el("categoryFilter").addEventListener("change", () => {
  currentPage = 1;
  loadItems();
});

el("refreshBtn").onclick = loadItems;

/***********************
 INIT
************************/
loadCategories();
loadItems();
</script>

</body>
</html>
